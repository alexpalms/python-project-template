name: Publish Python package (tag -> PyPI + Release)

on:
  push:
    tags:
      - 'v*'            # only run on tag pushes; we validate semver below
  workflow_dispatch:    # allow manual runs

permissions:
  contents: write

jobs:
  publish:
    name: Package publish
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract tag
        run: echo "TAG=${GITHUB_REF#refs/tags/}" >> $GITHUB_ENV

      - name: Validate tag is semver vX.Y.Z
        run: |
          echo "Tag: $TAG"
          if ! echo "$TAG" | grep -Eq '^v[0-9]+\.[0-9]+\.[0-9]+(-[A-Za-z0-9.+-]+)?$'; then
            echo "Tag does not match semver vX.Y.Z"
            exit 1
          fi

      - name: Verify pyproject.toml version matches tag
        run: |
          python - <<'PY'
          import os, sys
          try:
              import tomllib
          except Exception:
              print("Requires Python 3.11+ for tomllib; ensure astral UV provides the interpreter")
              sys.exit(2)
          tag = os.environ.get("TAG", "")
          try:
              with open("pyproject.toml","rb") as f:
                  data = tomllib.load(f)
          except FileNotFoundError:
              print("pyproject.toml not found")
              sys.exit(1)
          ver = (data.get("project",{}) or {}).get("version") or (data.get("tool",{}) or {}).get("poetry",{}).get("version")
          if not ver:
              print("version not found in pyproject.toml")
              sys.exit(1)
          if ver != tag.lstrip("v"):
              print(f"version mismatch: pyproject.toml={ver} tag={tag}")
              sys.exit(1)
          print("version matches tag")
          PY

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Build with astral UV
        run: |
          uv build

      - name: Check distribution with Twine
        run: |
          uv run twine check dist/*

      - name: Create GitHub Release and upload artifacts
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.TAG }}
          files: dist/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish with astral UV (PyPI)
        env:
          UV_PUBLISH_TOKEN: ${{ secrets.PYPI_API_TOKEN }}
        run: |
          uv publish --token $UV_PUBLISH_TOKEN
